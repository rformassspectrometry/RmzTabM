% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/MTD.R
\name{MTD-export}
\alias{MTD-export}
\title{Defining and exporting the mzTab-M metadata table}
\description{
The metadata section/table of the mzTab-M definition is comprehensive, but
also tricky to define. The \emph{RmzTabM} package provides a variety of utility
functions that help defining this information. These might be re-used for
software package developers to export metabolomics results from their
respective software. Importantly, the helper functions listed here only
define the core elements for the MTD section, helping with re-arranging and
reformatting information available e.g. in \code{data.frame} format into the
respective fields in the MTD section. Additional (optional) fields might
need to be added manually depending on availability for an experiment.

See also the \href{https://github.com/HUPO-PSI/mzTab-M/blob/main/specification_documents/mzTab_format_specification_2_1-M.adoc#62-metadata-section}{specification of the MTD section}
for details and more information, in particular on the format of the mzTab-M
and on mandatory or optional fields.

Generally, MTD data can be categorized into the following parts:
\itemize{
\item \emph{Core information}: general information on the experiment. A minimal
set can be created using the \code{\link[=mtd_skeleton]{mtd_skeleton()}} function, which might be
further expanded with additional fields. This section allows to describe
the general experimental setup. Also, it should contain references to
\strong{all} controlled vocabulary (CV) ontologies used and refered to in the
mzTab-M file.
\item \emph{Sample information}: optional information on individual samples that were
measured with the various \emph{assays}/\emph{runs}. The \code{\link[=mtd_sample]{mtd_sample()}} function
assists in compiling the information for this section.
\item \emph{MS run information}: information on the individual MS \emph{runs}
(measurements of the samples). Each data file is one run. Use the
\code{\link[=mtd_ms_run]{mtd_ms_run()}} function to define this part of the metadata section.
\item \emph{Assay information}: the \code{\link[=mtd_assay]{mtd_assay()}} function assists in compiling the
assay section of the metadata. Mandatory fields are the name (ID) of the
assay and the reference to the \emph{MS run} in which the assay was measured.
Optional information on sample reference, external links or custom
information can be provided too. In most cases (except multiplexed assays
or pre-fractionated samples) one assay will link to one MS run. Each assay
\strong{must} represent one column in the following \emph{abundance matrix} sections.
\item \emph{Study variable information}: the \code{\link[=mtd_study_variables]{mtd_study_variables()}} function allows
to format study variable information from an experiment into the mzTab-M
format. All study variables need to be assigned to at least one assay and
must also be reported in the subsequent abundance matrices.
}

The helper function listed above can be used sequentially to create the
metadata information. See the examples below for a general approach how to
define the MTD section of an experiment.

In addition, various helper functions are available to assist in MTD data
generation:
\itemize{
\item \code{\link[=mtd_sort]{mtd_sort()}}: to sort the MTD \code{matrix} into the expected order.
\item \code{\link[=mtd_fields]{mtd_fields()}}: helps formatting values into the mzTab-M-specific format.
}
}
\note{
The general relationship between \emph{ms_run}, \emph{assay} and \emph{sample}:
\itemize{
\item one \emph{ms_run} is the measurement of one assay.
\item one assay can be measured by several MS runs (if fractionated) or multiple
assays can be measured in the same MS run (if multiplexed).
\item one assay is (generally) one sample, but the same sample can be measured
with multiple assays.
}
}
\examples{

## Building the mzTab-M metadata information from a `data.frame` with sample
## information of an experiment. Each row in that `data.frame` is one
## measurement of one sample (i.e., represents one *ms_run*). Columns in
## that `data.frame` provide the phenotypic and experimental variables of
## each sample. The example below represents a simple experiment in which
## 3 samples (e.g. cell lines) were measured, each at two different time
## points (0 and 6 hours). In addition, one sample has the genotype *WT* and
## two *KO*. Column `"operator"` contains the initials of the researcher
## extracting the samples
exp <- data.frame(
    sample_name = c("S1_T1", "S1_T2", "S2_T1", "S2_T2", "S3_T1", "S3_T2"),
    sample_id = c("S1", "S1", "S2", "S2", "S3", "S3"),
    timepoint = c("0h", "6h", "0h", "6h", "0h", "6h"),
    genotype = c("WT", "WT", "KO", "KO", "KO", "KO"),
    operator = c("BB", "BB", "BB", "BB", "FB", "FB"),
    file_name = c("s1-t1.mzML", "s1-t2.mzML", "s2-t1.mzML", "s2-t2.mzML",
                  "s3-t1.mzML", "s3-t2.mzML")
)
exp


#############################################################################
## Core metadata information

## We first compile the general metadata information. For the present
## example we assume that we performed only preprocessing of the raw MS
## data using *xcms*, thus we don't specify annotation databases used for
## the compound identification/annotation. These could be provided through
## the `database*` parameters. Also, the quantification method and unit(s)
## could be specified using respective parameters of the function.
mtd <- mtd_skeleton(
    id = "EXP_001",
    software = "[MS, MS:1001582], xcms, 4.0.0")
mtd

## We next manually add a title and description for the experiment.
mtd <- rbind(
    mtd,
    c("title", "Experiment 1 preprocessed data"),
    c("description", "The preprocessed data of the experiment 1 samples."))

## We also add information on the MS instrumentation used
instr <- mtd_fields(
    name = "[MS, MS:1000449, LTQ Orbitrap,]",
    source = "[MS, MS:1000073, ESI,]",
    `analyzer[1]` = "[MS, MS:1000291, linear ion trap,]",
    detector = "[MS, MS:1000253, electron multiplier,]",
    field_prefix = "instrument"
)
instr

## Add this information to the metadata
mtd <- rbind(mtd, instr)

## Other information, such as employed sample processing methods could be
## added in a similar way.


#############################################################################
## Sample information

## We next add sample information to the metadata. In addition to the
## specific sample properties that can be defined using the function's
## parameters, arbitrary custom fields can be defined too. Below we add
## information on sample extraction as custom information.
mtd_s <- mtd_sample(
    sample = unique(exp$sample_id),
    species = "[NCBITaxon, NCBITaxon:9606, Homo sapiens, ]",
    tissue = "[BTO, BTO:0000759, liver, ]",
    cell_type = "[CL, CL:0000182, hepatocyte, ]",
    c("[,,Extraction date, 2011-12-21]",
      "[,,Extraction date, 2011-12-22]",
      "[,,Extraction date, 2011-12-23]")
    )
mtd_s

mtd <- rbind(mtd, mtd_s)


#############################################################################
## MS run information

## The MS run information should capture information of each individual
## measurement run on an MS instrument. For this, the original data file
## names and location should be provided as well as the format of the
## data files as well as polarity etc.
mtd_msr <- mtd_ms_run(
    location = exp$file_name,
    format = "[MS, MS:1000584, mzML file, ]",
    id_format = "[MS, MS:1000530, mzML unique identifier, ]",
    scan_polarity = "positive")

mtd <- rbind(mtd, mtd_msr)


#############################################################################
## Assay information

## Each measurement should be associated to (at least) one assay. For our
## simple example, each row in the `data.frame` represents one assay, with
## each assay being measured in one MS run.
a <- mtd_assay(
    assay = exp$sample_name,
    sample_ref = c("sample[1]", "sample[1]", "sample[2]", "sample[2]",
                   "sample[3]", "sample[3]"),
    ms_run_ref = paste0("ms_run[", seq_len(nrow(exp)), "]")
)
a

mtd <- rbind(mtd, a)


#############################################################################
## Study variable information

## Study variables can be defined directly from the experiment `data.frame`.
## In our example we use the columns (information on) `"timepoint"`,
## `"genotype"` and `"operator"`. Importantly, the order of the provided
## `data.frame` has to match the order of the assays (and MS runs).
svar <- mtd_study_variables(
    exp,
    study_variable_columns = c("timepoint", "genotype", "operator"))
svar

mtd <- rbind(mtd, svar)

## Finally, the `mtd_sort()` function can be used to sort the generated
## two-column matrix in the expected order.
mtd <- mtd_sort(mtd)

## This metadata information can next be exported manually, or using the
## dedicated export helper functions to an mzTab-M file.
}
\author{
Philippine Louail, Johannes Rainer
}
